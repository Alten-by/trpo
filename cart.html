<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Корзина - SwiftBuy</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<nav class="main-nav">
    <div class="nav-brand">
        <h1><a href="index.html" style="color: inherit; text-decoration: none;">SwiftBuy</a></h1>
    </div>
    <div class="nav-links">
        <a href="index.html">Главная</a>
        <a href="#" onclick="event.preventDefault();">Корзина</a>
        <a href="#" onclick="goToRequests(event); return false;">Заявки</a>
        <a href="about.html">О нас</a>
        <div class="nav-search">
            <div class="search-wrapper">
                <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text" name="Search" class="search-input" placeholder="Поиск товаров..." autocomplete="off">
                <button class="search-clear" id="search-clear" style="display: none;">×</button>
            </div>
        </div>
        <div class="user-menu-container">
            <button class="user-icon-btn" id="user-icon-btn" onclick="toggleUserMenu()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            </button>
            <div class="user-dropdown" id="user-dropdown">
                <div id="user-menu-content">
                    <!-- Содержимое заполняется динамически -->
                </div>
            </div>
        </div>
    </div>
</nav>

<main class="cart-page">
    <div class="cart-header">
        <h1>Корзина</h1>
        <button class="link-btn" id="clear-cart-btn">Очистить корзину</button>
    </div>
    <div class="cart-layout" id="cart-layout">
        <div class="cart-items" id="cart-items">
            <div class="cart-empty">
                <h2>Ваша корзина пуста</h2>
                <p>Загляните в каталог, чтобы выбрать подходящий товар.</p>
                <a href="index.html" class="primary-btn-link">Перейти к покупкам</a>
            </div>
        </div>
        <aside class="cart-summary" id="cart-summary">
            <h2>Итого</h2>
            <div class="summary-row">
                <span>Товары</span>
                <span id="summary-items-count">0</span>
            </div>
            <div class="summary-row">
                <span>Сумма</span>
                <span id="summary-total">0 руб.</span>
            </div>
            <p class="summary-note" id="summary-note">Авторизуйтесь, чтобы оформить заказ.</p>
            <button class="primary-btn" id="checkout-btn">Перейти к оформлению</button>
        </aside>
    </div>
</main>

<div class="checkout-modal-overlay" id="checkout-modal">
    <div class="checkout-modal-dialog">
        <button class="checkout-modal-close" data-action="close-checkout" aria-label="Закрыть">&times;</button>
        <h3>Оформление заявки</h3>
        <p class="checkout-modal-description">Укажите получателя и адрес доставки. Мы отправим заявку поставщику.</p>
        <form id="checkout-form" class="checkout-form">
            <div class="form-group">
                <label for="checkout-recipient">Имя получателя</label>
                <input type="text" id="checkout-recipient" name="recipient" placeholder="ФИО получателя" required>
            </div>
            <div class="form-group">
                <label for="checkout-address">Адрес доставки</label>
                <textarea id="checkout-address" name="address" rows="3" placeholder="Город, улица, дом..." required></textarea>
            </div>
            <div id="checkout-error" class="error-message" style="display: none;"></div>
            <div class="checkout-form-actions">
                <button type="button" class="link-btn subtle" data-action="close-checkout">Отмена</button>
                <button type="submit" class="primary-btn" id="checkout-submit-btn">Оформить заявку</button>
            </div>
        </form>
    </div>
</div>

<footer>
    <div class="footer-content">
        <div class="footer-description">
            <p>Основанные на передовых технологиях и инновационных решениях, устройства SwiftBuy позволяют вам пользоваться последними достижениями технического прогресса вместе с проверенной надежностью ведущих мировых брендов. Каждое устройство в нашем каталоге проходит многоуровневую проверку качества, что гарантирует безупречную работу и долговечность эксплуатации.</p>
        </div>
        <p class="footer-copyright">&copy; 2025 SwiftBuy. Все права защищены.</p>
    </div>
</footer>

<script>
const PLACEHOLDER_IMAGE = 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a3/ThinkCentre_S50.jpg/960px-ThinkCentre_S50.jpg';
let cachedCartItems = [];
let checkoutModalReady = false;

function updateAuthNav() {
    const isAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    const userMenuContent = document.getElementById('user-menu-content');

    if (!userMenuContent) return;

    if (isAuthenticated && user) {
        const role = user.role || user.role_name || 'customer';
        const isSupplier = role === 'supplier';
        const isAdmin = role === 'admin';
        const companyBlock = isSupplier ? `<div class="user-company">${user.company_name || 'LocalStore'}</div>` : '';
            const adminLink = isAdmin ? '<a href="admin.html" class="dropdown-item">Админ-панель</a>' : '';
            const supplierLink = isSupplier ? '<a href="supplier.html" class="dropdown-item">Мои товары</a>' : '';

        userMenuContent.innerHTML = `
            <div class="user-info">
                <div class="user-name">${user.fio}</div>
                <div class="user-email">${user.email}</div>
                ${companyBlock}
            </div>
            <div class="dropdown-divider"></div>
                <a href="profile.html" class="dropdown-item">Личный кабинет</a>
                ${adminLink}
                ${supplierLink}
                <a href="#" class="dropdown-item" onclick="logout(); return false;">Выйти</a>
        `;
    } else {
        userMenuContent.innerHTML = `
            <a href="login.html" class="dropdown-item">Войти</a>
            <a href="register.html" class="dropdown-item">Регистрация</a>
        `;
    }
}

function toggleUserMenu() {
    const dropdown = document.getElementById('user-dropdown');
    if (dropdown) {
        dropdown.classList.toggle('show');
    }
}

document.addEventListener('click', function(event) {
    const userMenuContainer = document.querySelector('.user-menu-container');
    const dropdown = document.getElementById('user-dropdown');
    
    if (userMenuContainer && !userMenuContainer.contains(event.target)) {
        if (dropdown) {
            dropdown.classList.remove('show');
        }
    }
});

function logout() {
    localStorage.removeItem('user');
    localStorage.removeItem('isAuthenticated');
    updateAuthNav();
    const dropdown = document.getElementById('user-dropdown');
    if (dropdown) {
        dropdown.classList.remove('show');
    }
}

// Функция перехода к заявкам
function goToRequests(event) {
    event.preventDefault();
    const user = getCurrentUser();

    if (!user || !user.id) {
        window.location.href = 'login.html';
        return;
    }

    const role = (user.role || user.role_name || '').toLowerCase();
    if (role === 'supplier') {
        window.location.href = 'supplier-requests.html';
    } else {
        window.location.href = 'requests.html';
    }
}

function setupSearchStub() {
    const searchInput = document.querySelector('.search-input');
    const searchClear = document.getElementById('search-clear');

    if (!searchInput || !searchClear) return;

    searchInput.addEventListener('input', function(e) {
        const value = e.target.value.trim();
        searchClear.style.display = value.length ? 'flex' : 'none';
    });

    searchClear.addEventListener('click', function() {
        searchInput.value = '';
        searchClear.style.display = 'none';
        searchInput.focus();
    });
}

function setSummaryNote(message) {
    const summaryNote = document.getElementById('summary-note');
    if (summaryNote) {
        summaryNote.textContent = message;
    }
}

// Получить текущего пользователя
function getCurrentUser() {
    const isAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
    if (!isAuthenticated) {
        return null;
    }
    try {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        return user;
    } catch (error) {
        return null;
    }
}

// Получить корзину из БД
async function safeGetCart() {
    const user = getCurrentUser();
    if (!user || !user.id) {
        return [];
    }

    try {
        const response = await fetch(`http://localhost:3000/api/cart?user_id=${user.id}`);
        if (!response.ok) {
            throw new Error('Ошибка при загрузке корзины');
        }
        const cart = await response.json();
        return Array.isArray(cart) ? cart : [];
    } catch (error) {
        console.error('Ошибка при получении корзины:', error);
        return [];
    }
}

async function renderCart() {
    const itemsContainer = document.getElementById('cart-items');
    const summaryContainer = document.getElementById('cart-summary');

    if (!itemsContainer || !summaryContainer) return;
    cachedCartItems = [];

    // Проверяем авторизацию
    const user = getCurrentUser();
    if (!user || !user.id) {
        itemsContainer.innerHTML = `
            <div class="cart-empty">
                <h2>Войдите в аккаунт, чтобы просмотреть корзину</h2>
                <p>Для работы с корзиной необходимо авторизоваться.</p>
                <a href="login.html" class="primary-btn-link">Войти</a>
            </div>
        `;
        updateSummary(0, 0);
        setSummaryNote('Авторизуйтесь, чтобы оформить заявку.');
        return;
    }

    const cart = await safeGetCart();
    cachedCartItems = cart;

    if (!cart.length) {
        itemsContainer.innerHTML = `
            <div class="cart-empty">
                <h2>Ваша корзина пуста</h2>
                <p>Загляните в каталог, чтобы выбрать подходящий товар.</p>
                <a href="index.html" class="primary-btn-link">Перейти к покупкам</a>
            </div>
        `;
        updateSummary(0, 0);
        setSummaryNote('Добавьте товары в корзину, чтобы оформить заявку.');
        return;
    }
    setSummaryNote('Нажмите «Перейти к оформлению», чтобы указать данные получателя.');

    itemsContainer.innerHTML = cart.map(item => `
        <div class="cart-item" data-id="${item.id}">
            <div class="cart-item-image">
                <img src="${item.image || PLACEHOLDER_IMAGE}" alt="${item.name}" onerror="this.src='${PLACEHOLDER_IMAGE}'">
            </div>
            <div class="cart-item-info">
                <h3>${item.name}</h3>
                <p class="cart-item-price">${item.price.toFixed(2)} руб.</p>
                <div class="cart-item-actions">
                    <div class="quantity-selector compact">
                        <button type="button" class="quantity-btn" data-action="minus">−</button>
                        <input type="number" class="quantity-input" value="${item.quantity}" min="1">
                        <button type="button" class="quantity-btn" data-action="plus">+</button>
                    </div>
                    <button class="link-btn remove-btn">Удалить</button>
                </div>
            </div>
        </div>
    `).join('');

    updateSummary(
        cart.reduce((acc, item) => acc + item.quantity, 0),
        cart.reduce((acc, item) => acc + item.price * item.quantity, 0)
    );
}

function updateSummary(totalItems, totalPrice) {
    const itemsCountElement = document.getElementById('summary-items-count');
    const totalElement = document.getElementById('summary-total');

    if (itemsCountElement) {
        itemsCountElement.textContent = totalItems;
    }
    if (totalElement) {
        totalElement.textContent = `${totalPrice.toFixed(2)} руб.`;
    }
}

function attachCartEvents() {
    const itemsContainer = document.getElementById('cart-items');
    const clearCartBtn = document.getElementById('clear-cart-btn');
    const checkoutBtn = document.getElementById('checkout-btn');

    if (itemsContainer) {
        itemsContainer.addEventListener('click', function(event) {
            const target = event.target;
            const cartItem = target.closest('.cart-item');
            if (!cartItem) return;

            const productId = Number(cartItem.dataset.id);
            if (!productId) return;

            if (target.classList.contains('quantity-btn')) {
                const input = cartItem.querySelector('.quantity-input');
                const action = target.dataset.action;
                let value = Number(input.value) || 1;

                if (action === 'minus') {
                    value = Math.max(1, value - 1);
                } else if (action === 'plus') {
                    value += 1;
                }
                input.value = value;
                updateItemQuantity(productId, value);
            }

            if (target.classList.contains('remove-btn')) {
                removeItemFromCart(productId);
            }
        });

        itemsContainer.addEventListener('change', function(event) {
            if (!event.target.classList.contains('quantity-input')) return;
            const cartItem = event.target.closest('.cart-item');
            if (!cartItem) return;

            const productId = Number(cartItem.dataset.id);
            let value = Math.max(1, Number(event.target.value) || 1);
            event.target.value = value;
            updateItemQuantity(productId, value);
        });
    }

    if (clearCartBtn) {
        clearCartBtn.addEventListener('click', async function() {
            const user = getCurrentUser();
            if (!user || !user.id) {
                showCartToast('Войдите в аккаунт для работы с корзиной');
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/cart?user_id=${user.id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Ошибка при очистке корзины');
                }

                await renderCart();
                showCartToast('Корзина очищена');
            } catch (error) {
                console.error('Ошибка при очистке корзины:', error);
                showCartToast('Не удалось очистить корзину. Попробуйте позже.');
            }
        });
    }

    if (checkoutBtn) {
        checkoutBtn.addEventListener('click', function() {
            const user = getCurrentUser();
            if (!user || !user.id) {
                showCartToast('Войдите в аккаунт для оформления заказа');
                window.location.href = 'login.html';
                return;
            }

            if (!cachedCartItems.length) {
                showCartToast('Корзина пуста');
                return;
            }
            openCheckoutModal();
        });
    }
}

function toggleCheckoutModal(show) {
    const overlay = document.getElementById('checkout-modal');
    if (!overlay) return;

    if (show) {
        overlay.classList.add('show');
        document.body.classList.add('modal-open');
    } else {
        overlay.classList.remove('show');
        document.body.classList.remove('modal-open');
    }

    const errorBox = document.getElementById('checkout-error');
    if (errorBox) {
        errorBox.style.display = 'none';
        errorBox.textContent = '';
    }
}

function openCheckoutModal() {
    const user = getCurrentUser();
    if (!user || !user.id) {
        showCartToast('Войдите в аккаунт для оформления');
        return;
    }

    if (!cachedCartItems.length) {
        showCartToast('Корзина пуста');
        return;
    }

    const recipientInput = document.getElementById('checkout-recipient');
    if (recipientInput) {
        recipientInput.value = user.fio || '';
    }

    toggleCheckoutModal(true);
}

function closeCheckoutModal() {
    toggleCheckoutModal(false);
}

async function handleCheckoutSubmit(event) {
    event.preventDefault();

    const user = getCurrentUser();
    if (!user || !user.id) {
        showCartToast('Войдите в аккаунт для оформления');
        closeCheckoutModal();
        return;
    }

    if (!cachedCartItems.length) {
        showCartToast('Корзина пуста');
        closeCheckoutModal();
        return;
    }

    const recipientInput = document.getElementById('checkout-recipient');
    const addressInput = document.getElementById('checkout-address');
    const errorBox = document.getElementById('checkout-error');
    const submitBtn = document.getElementById('checkout-submit-btn');

    const recipient = (recipientInput?.value || '').trim() || user.fio || '';
    const address = (addressInput?.value || '').trim();

    if (!address) {
        if (errorBox) {
            errorBox.textContent = 'Введите адрес доставки';
            errorBox.style.display = 'block';
        }
        return;
    } else if (errorBox) {
        errorBox.style.display = 'none';
        errorBox.textContent = '';
    }

    const originalText = submitBtn ? submitBtn.textContent : '';
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Оформляем...';
    }

    try {
        const response = await fetch('http://localhost:3000/requests/checkout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                userId: user.id,
                recipientName: recipient,
                deliveryAddress: address
            })
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.error || 'Не удалось оформить заявку');
        }

        showCartToast(data.message || `Заявка оформлена. Статус: ${data.status}`);
        closeCheckoutModal();
        await renderCart();
    } catch (error) {
        console.error('Ошибка при оформлении заявки:', error);
        if (errorBox) {
            errorBox.textContent = error.message || 'Не удалось оформить заявку. Попробуйте позже.';
            errorBox.style.display = 'block';
        }
    } finally {
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText || 'Оформить заявку';
        }
    }
}

function initCheckoutModal() {
    if (checkoutModalReady) return;
    const overlay = document.getElementById('checkout-modal');
    if (!overlay) return;

    checkoutModalReady = true;

    overlay.addEventListener('click', (event) => {
        if (event.target === overlay) {
            closeCheckoutModal();
        }
    });

    const closeButtons = overlay.querySelectorAll('[data-action="close-checkout"]');
    closeButtons.forEach((btn) => btn.addEventListener('click', closeCheckoutModal));

    const form = document.getElementById('checkout-form');
    if (form) {
        form.addEventListener('submit', handleCheckoutSubmit);
    }

    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && overlay.classList.contains('show')) {
            closeCheckoutModal();
        }
    });
}

async function updateItemQuantity(productId, quantity) {
    const user = getCurrentUser();
    if (!user || !user.id) {
        showCartToast('Войдите в аккаунт для работы с корзиной');
        return;
    }

    try {
        const response = await fetch(`http://localhost:3000/api/cart/${productId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: user.id,
                quantity: quantity
            })
        });

        if (!response.ok) {
            throw new Error('Ошибка при обновлении количества');
        }

        await renderCart();
    } catch (error) {
        console.error('Ошибка при обновлении количества:', error);
        showCartToast('Не удалось обновить количество. Попробуйте позже.');
        await renderCart(); // Перезагружаем корзину в случае ошибки
    }
}

async function removeItemFromCart(productId) {
    const user = getCurrentUser();
    if (!user || !user.id) {
        showCartToast('Войдите в аккаунт для работы с корзиной');
        return;
    }

    try {
        const response = await fetch(`http://localhost:3000/api/cart/${productId}?user_id=${user.id}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            throw new Error('Ошибка при удалении товара');
        }

        await renderCart();
        showCartToast('Товар удалён из корзины');
    } catch (error) {
        console.error('Ошибка при удалении товара:', error);
        showCartToast('Не удалось удалить товар. Попробуйте позже.');
    }
}

function showCartToast(message) {
    let toastContainer = document.querySelector('.cart-toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'cart-toast-container';
        document.body.appendChild(toastContainer);
    }

    const toast = document.createElement('div');
    toast.className = 'cart-toast';
    toast.textContent = message;
    toastContainer.appendChild(toast);

    requestAnimationFrame(() => toast.classList.add('show'));

    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 2500);
}

document.addEventListener('DOMContentLoaded', function() {
    updateAuthNav();
    setupSearchStub();
    renderCart();
    attachCartEvents();
    initCheckoutModal();
});
</script>

</body>
</html>


