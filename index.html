<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwiftBuy - Магазин электроники</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- Объединенная шапка с названием, навигацией и поиском -->
<nav class="main-nav">
    <div class="nav-brand">
        <h1>SwiftBuy</h1>
    </div>
    <div class="nav-links">
        <a href="index.html">Главная</a>
        <a href="#" onclick="goToCart(event); return false;">Корзина</a>
        <a href="#" onclick="goToRequests(event); return false;">Заявки</a>
        <a href="about.html">О нас</a>
        <div class="nav-search">
        <div class="search-wrapper">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" name="Search" class="search-input" placeholder="Поиск товаров..." autocomplete="off">
            <button class="search-clear" id="search-clear" style="display: none;">×</button>
        </div>
        </div>
        <!-- Иконка пользователя с выпадающим меню -->
        <div class="user-menu-container">
            <button class="user-icon-btn" id="user-icon-btn" onclick="toggleUserMenu()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            </button>
            <div class="user-dropdown" id="user-dropdown">
                <div id="user-menu-content">
                    <!-- Содержимое будет добавлено динамически -->
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- ОСНОВНОЙ КОНТЕЙНЕР С ФИЛЬТРАМИ И КАРТОЧКАМИ -->
<div class="main-content-wrapper">
    <!-- ЛЕВАЯ КОЛОНКА С ФИЛЬТРАМИ -->
    <div class="filters-container">
        <!-- Информационный блок с количеством товаров -->
        <div class="info-section">
            <div class="info-item">
                <span class="info-label">Товаров на сайте:</span>
                <span class="info-value" id="products-count">0</span>
            </div>
        </div>
        <div class="CheckBox">
            <h1>Категории</h1>
            
            <div class="checkbox-group" id="categories-filter">
                <!-- Категории будут загружены динамически -->
                <div class="loading-categories">Загрузка категорий...</div>
            </div>
        </div>
    </div>

    <!-- ПРАВАЯ КОЛОНКА С КАРТОЧКАМИ -->
    <div class="products-container">
        <div class="products-grid" id="products-grid">
            <!-- Карточки будут загружаться динамически -->
            <div class="loading">Загрузка товаров...</div>
        </div>
        
        <!-- Пагинация -->
        <div class="pagination-container" id="pagination-container">
            <!-- Кнопки пагинации будут добавлены динамически -->
        </div>
    </div>
</div>

<footer>
    <div class="footer-content">
        <div class="footer-description">
            <p>Основанные на передовых технологиях и инновационных решениях, устройства SwiftBuy позволяют вам пользоваться последними достижениями технического прогресса вместе с проверенной надежностью ведущих мировых брендов. Каждое устройство в нашем каталоге проходит многоуровневую проверку качества, что гарантирует безупречную работу и долговечность эксплуатации.</p>
        </div>
        <p class="footer-copyright">&copy; 2025 SwiftBuy. Все права защищены.</p>
    </div>
</footer>

<script>
// Глобальные переменные
const PLACEHOLDER_IMAGE = 'https://via.placeholder.com/600x600?text=SwiftBuy';
let allProducts = [];
let filteredProducts = [];
let currentPage = 1;
const productsPerPage = 12; // 4 ряда по 3 товара

// Функция для загрузки товаров
async function loadProducts() {
    try {
        const response = await fetch('http://localhost:3000/products');
        allProducts = await response.json();
        filteredProducts = [...allProducts];
        
        // Обновляем количество товаров
        updateProductsCount();
        
        // Загружаем категории и отображаем товары
        setupCategories();
        displayProducts();
    } catch (error) {
        console.error('Ошибка при загрузке товаров:', error);
        document.getElementById('products-grid').innerHTML = 
            '<div class="error">Ошибка загрузки товаров. Проверьте подключение к серверу.</div>';
    }
}

// Функция для обновления количества товаров
function updateProductsCount() {
    const countElement = document.getElementById('products-count');
    if (countElement) {
        countElement.textContent = allProducts.length;
    }
}

// Функция для настройки категорий
function setupCategories() {
    // Получаем уникальные категории из товаров
    const categories = [...new Set(allProducts.map(p => p.category).filter(c => c))];
    const categoriesFilter = document.getElementById('categories-filter');
    
    if (categories.length === 0) {
        categoriesFilter.innerHTML = '<div class="no-categories">Категории не найдены</div>';
        return;
    }
    
    categoriesFilter.innerHTML = categories.map(category => `
        <div class="checkbox-item">
            <input type="checkbox" id="cat-${category.replace(/\s+/g, '-')}" 
                   value="${category}" onchange="filterByCategories()">
            <label for="cat-${category.replace(/\s+/g, '-')}">${category}</label>
        </div>
    `).join('');
}

// Функция для фильтрации по категориям
function filterByCategories() {
    const checkedCategories = Array.from(document.querySelectorAll('#categories-filter input[type="checkbox"]:checked'))
        .map(cb => cb.value);
    
    if (checkedCategories.length === 0) {
        // Если ничего не выбрано, показываем все товары
        filteredProducts = [...allProducts];
    } else {
        // Фильтруем товары по выбранным категориям
        filteredProducts = allProducts.filter(product => 
            product.category && checkedCategories.includes(product.category)
        );
    }
    
    currentPage = 1; // Сбрасываем на первую страницу
    displayProducts();
}

// Функция для отображения товаров с пагинацией
function displayProducts() {
    const productsGrid = document.getElementById('products-grid');
    
    if (!filteredProducts || filteredProducts.length === 0) {
        productsGrid.innerHTML = '<div class="no-products">Товары не найдены</div>';
        document.getElementById('pagination-container').innerHTML = '';
        return;
    }
    
    // Вычисляем пагинацию
    const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
    const startIndex = (currentPage - 1) * productsPerPage;
    const endIndex = startIndex + productsPerPage;
    const productsToShow = filteredProducts.slice(startIndex, endIndex);
    
    // Отображаем товары
    productsGrid.innerHTML = productsToShow.map(product => `
        <div class="product-card">
            <a class="product-link" href="product.html?id=${product.id}">
                <div class="product-image">
                    <img src="${product.image_url || 'https://via.placeholder.com/200x250?text=No+Image'}" 
                         alt="${product.name}" 
                         onerror="this.src='https://via.placeholder.com/200x250?text=No+Image'">
                </div>
                <div class="product-content">
                    <div class="product-category">${product.category || 'Электроника'}</div>
                    <h3 class="product-title">${product.name}</h3>
                    <div class="product-description">${product.description || ''}</div>
                    <div class="product-features">
                        <span class="feature">Арт: ${product.article}</span>
                        ${product.supplier ? `<span class="feature">${product.supplier}</span>` : ''}
                        ${product.quantity ? `<span class="feature">В наличии: ${product.quantity}</span>` : ''}
                    </div>
                </div>
            </a>
            <div class="product-card-footer">
                <div class="product-price">
                    <span class="current-price">${product.price ? product.price + ' руб.' : 'Цена не указана'}</span>
                </div>
                <button class="add-to-cart-btn" onclick="addToCart(${product.id})">В корзину</button>
            </div>
        </div>
    `).join('');
    
    // Отображаем пагинацию
    displayPagination(totalPages);
}

// Функция для отображения пагинации
function displayPagination(totalPages) {
    const paginationContainer = document.getElementById('pagination-container');
    
    if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        return;
    }
    
    let paginationHTML = '<div class="pagination">';
    
    // Кнопки страниц
    for (let i = 1; i <= totalPages; i++) {
        paginationHTML += `
            <button class="pagination-btn ${i === currentPage ? 'active' : ''}" 
                    onclick="goToPage(${i})">
                ${i}
            </button>
        `;
    }
    
    paginationHTML += '</div>';
    paginationContainer.innerHTML = paginationHTML;
}

// Функция для перехода на страницу
function goToPage(page) {
    const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    displayProducts();
    
    // Плавная прокрутка вверх
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Получить текущего пользователя
function getCurrentUser() {
    const isAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
    if (!isAuthenticated) {
        return null;
    }
    try {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        return user;
    } catch (error) {
        return null;
    }
}

async function addToCart(productId, quantity = 1) {
    const product = allProducts.find(p => p.id === productId);
    if (!product) {
        showCartToast('Не удалось добавить товар: не найден.');
        return;
    }

    // Проверяем авторизацию
    const user = getCurrentUser();
    if (!user || !user.id) {
        showCartToast('Войдите в аккаунт, чтобы добавить товар в корзину');
        setTimeout(() => {
            window.location.href = 'login.html';
        }, 1500);
        return;
    }

    const normalizedQuantity = Math.max(1, Number(quantity) || 1);

    try {
        const response = await fetch('http://localhost:3000/api/cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: user.id,
                product_id: productId,
                quantity: normalizedQuantity
            })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Ошибка при добавлении товара');
        }

        showCartToast(`«${product.name}» добавлен${normalizedQuantity > 1 ? 'ы' : ''} в корзину`);
    } catch (error) {
        console.error('Ошибка при добавлении в корзину:', error);
        showCartToast('Не удалось добавить товар в корзину. Попробуйте позже.');
    }
}

// Поиск товаров
function setupSearch() {
    const searchInput = document.querySelector('.search-input');
    const searchClear = document.getElementById('search-clear');
    
    if (searchInput) {
        // Обработка ввода
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            // Показываем/скрываем кнопку очистки
            if (searchTerm.length > 0) {
                searchClear.style.display = 'flex';
            } else {
                searchClear.style.display = 'none';
            }
            
            if (searchTerm === '') {
                filteredProducts = [...allProducts];
            } else {
                filteredProducts = allProducts.filter(product => 
                    (product.name && product.name.toLowerCase().includes(searchTerm)) ||
                    (product.description && product.description.toLowerCase().includes(searchTerm)) ||
                    (product.article && product.article.toLowerCase().includes(searchTerm))
                );
            }
            
            currentPage = 1;
            displayProducts();
        });
        
        // Очистка поиска
        if (searchClear) {
            searchClear.addEventListener('click', function() {
                searchInput.value = '';
                searchClear.style.display = 'none';
                filteredProducts = [...allProducts];
                currentPage = 1;
                displayProducts();
                searchInput.focus();
            });
        }
    }
}

// Функция для проверки авторизации и обновления меню пользователя
function updateAuthNav() {
    const isAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    const userMenuContent = document.getElementById('user-menu-content');
    
    if (userMenuContent) {
        if (isAuthenticated && user) {
            const role = user.role || user.role_name || 'customer';
            const isSupplier = role === 'supplier';
            const isAdmin = role === 'admin';
            const companyBlock = isSupplier ? `<div class="user-company">${user.company_name || 'LocalStore'}</div>` : '';
            const adminLink = isAdmin ? '<a href="admin.html" class="dropdown-item">Админ-панель</a>' : '';

            userMenuContent.innerHTML = `
                <div class="user-info">
                    <div class="user-name">${user.fio}</div>
                    <div class="user-email">${user.email}</div>
                    ${companyBlock}
                </div>
                <div class="dropdown-divider"></div>
                <a href="profile.html" class="dropdown-item">Личный кабинет</a>
                ${adminLink}
                <a href="#" class="dropdown-item" onclick="logout(); return false;">Выйти</a>
            `;
        } else {
            userMenuContent.innerHTML = `
                <a href="login.html" class="dropdown-item">Войти</a>
                <a href="register.html" class="dropdown-item">Регистрация</a>
            `;
        }
    }
}

// Функция для открытия/закрытия меню пользователя
function toggleUserMenu() {
    const dropdown = document.getElementById('user-dropdown');
    if (dropdown) {
        dropdown.classList.toggle('show');
    }
}

// Закрываем меню при клике вне его
document.addEventListener('click', function(event) {
    const userMenuContainer = document.querySelector('.user-menu-container');
    const userIconBtn = document.getElementById('user-icon-btn');
    const dropdown = document.getElementById('user-dropdown');
    
    if (userMenuContainer && !userMenuContainer.contains(event.target)) {
        if (dropdown) {
            dropdown.classList.remove('show');
        }
    }
});

// Функция выхода
function logout() {
    localStorage.removeItem('user');
    localStorage.removeItem('isAuthenticated');
    const dropdown = document.getElementById('user-dropdown');
    if (dropdown) {
        dropdown.classList.remove('show');
    }
    updateAuthNav();
    window.location.reload();
}

// Функция перехода в корзину
function goToCart(event) {
    event.preventDefault();
    window.location.href = 'cart.html';
}

// Функция перехода к заявкам
function goToRequests(event) {
    event.preventDefault();
    const isAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    
    if (!isAuthenticated || !user) {
        window.location.href = 'login.html';
        return;
    }
    
    // Показываем уведомление о том, что функция в разработке
    showCartToast('Функция в разработке');
}

// Небольшое уведомление о добавлении в корзину
function showCartToast(message) {
    let toastContainer = document.querySelector('.cart-toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'cart-toast-container';
        document.body.appendChild(toastContainer);
    }

    const toast = document.createElement('div');
    toast.className = 'cart-toast';
    toast.textContent = message;
    toastContainer.appendChild(toast);

    requestAnimationFrame(() => {
        toast.classList.add('show');
    });

    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 2500);
}

// Загружаем товары при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadProducts();
    setupSearch();
    updateAuthNav();
});
</script>

</body>
</html>
