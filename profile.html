<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный кабинет - SwiftBuy</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- Объединенная шапка с названием, навигацией и поиском -->
<nav class="main-nav">
    <div class="nav-brand">
        <h1><a href="index.html" style="color: inherit; text-decoration: none;">SwiftBuy</a></h1>
    </div>
    <div class="nav-links">
        <a href="index.html">Главная</a>
        <a href="#" onclick="goToCart(event); return false;">Корзина</a>
        <a href="#" onclick="goToRequests(event); return false;">Заявки</a>
        <a href="about.html">О нас</a>
        <div class="nav-search">
        <div class="search-wrapper">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" name="Search" class="search-input" placeholder="Поиск товаров..." autocomplete="off">
            <button class="search-clear" id="search-clear" style="display: none;">×</button>
        </div>
        </div>
        <!-- Иконка пользователя с выпадающим меню -->
        <div class="user-menu-container">
            <button class="user-icon-btn" id="user-icon-btn" onclick="toggleUserMenu()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            </button>
            <div class="user-dropdown" id="user-dropdown">
                <div id="user-menu-content">
                    <!-- Содержимое будет добавлено динамически -->
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Контейнер личного кабинета -->
<div class="profile-container">
    <div class="profile-content">
        <h1 class="profile-title">Личный кабинет</h1>
        
        <!-- Информация о пользователе -->
        <div class="profile-section">
            <h2 class="section-title">Информация о пользователе</h2>
            <div class="user-info-display">
                <div class="info-row">
                    <span class="info-label">ФИО:</span>
                    <span class="info-value" id="user-fio">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Email:</span>
                    <span class="info-value" id="user-email">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Телефон:</span>
                    <span class="info-value" id="user-phone">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Роль:</span>
                    <span class="info-value" id="user-role">-</span>
                </div>
                <div class="info-row" id="company-row" style="display: none;">
                    <span class="info-label">Компания:</span>
                    <span class="info-value" id="user-company">-</span>
                </div>
            </div>
        </div>

        <!-- Изменение email (логина) -->
        <div class="profile-section">
            <h2 class="section-title">Изменить email</h2>
            <form id="changeEmailForm" class="profile-form">
                <div class="form-group">
                    <label for="currentEmail">Текущий email</label>
                    <input type="email" id="currentEmail" name="currentEmail" readonly>
                </div>
                
                <div class="form-group">
                    <label for="newEmail">Новый email</label>
                    <input type="email" id="newEmail" name="newEmail" required placeholder="example@mail.com">
                </div>
                
                <div class="form-group">
                    <label for="emailPassword">Подтвердите паролем</label>
                    <input type="password" id="emailPassword" name="emailPassword" required placeholder="Введите текущий пароль">
                </div>
                
                <div id="email-error-message" class="error-message" style="display: none;"></div>
                <div id="email-success-message" class="success-message" style="display: none;"></div>
                
                <button type="submit" class="auth-button">Изменить email</button>
            </form>
        </div>

        <!-- Изменение пароля -->
        <div class="profile-section">
            <h2 class="section-title">Изменить пароль</h2>
            <form id="changePasswordForm" class="profile-form">
                <div class="form-group">
                    <label for="currentPassword">Текущий пароль</label>
                    <input type="password" id="currentPassword" name="currentPassword" required placeholder="Введите текущий пароль">
                </div>
                
                <div class="form-group">
                    <label for="newPassword">Новый пароль</label>
                    <input type="password" id="newPassword" name="newPassword" required placeholder="Минимум 6 символов" minlength="6">
                </div>
                
                <div class="form-group">
                    <label for="confirmNewPassword">Подтвердите новый пароль</label>
                    <input type="password" id="confirmNewPassword" name="confirmNewPassword" required placeholder="Повторите новый пароль">
                </div>
                
                <div id="password-error-message" class="error-message" style="display: none;"></div>
                <div id="password-success-message" class="success-message" style="display: none;"></div>
                
                <button type="submit" class="auth-button">Изменить пароль</button>
            </form>
        </div>

    </div>
</div>

<footer>
    <div class="footer-content">
        <div class="footer-description">
            <p>Основанные на передовых технологиях и инновационных решениях, устройства SwiftBuy позволяют вам пользоваться последними достижениями технического прогресса вместе с проверенной надежностью ведущих мировых брендов. Каждое устройство в нашем каталоге проходит многоуровневую проверку качества, что гарантирует безупречную работу и долговечность эксплуатации.</p>
        </div>
        <p class="footer-copyright">&copy; 2025 SwiftBuy. Все права защищены.</p>
    </div>
</footer>

<script>
const DEFAULT_COMPANY_NAME = 'LocalStore';
const ROLE_TITLES = {
    admin: 'Администратор',
    supplier: 'Поставщик',
    customer: 'Покупатель',
    guest: 'Гость'
};

function getStoredUser() {
    try {
        return JSON.parse(localStorage.getItem('user') || 'null');
    } catch (error) {
        return null;
    }
}

function getUserRole(user) {
    if (!user) return 'guest';
    return user.role || user.role_name || 'customer';
}

function getRoleTitle(role) {
    return ROLE_TITLES[role] || 'Пользователь';
}

function isAdmin(user) {
    return getUserRole(user) === 'admin';
}

function isSupplier(user) {
    return getUserRole(user) === 'supplier';
}

function escapeHtml(value) {
    if (value === null || value === undefined) {
        return '';
    }
    return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

// Проверка авторизации при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    const isAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
    const user = getStoredUser();
    
    if (!isAuthenticated || !user) {
        alert('Для доступа к личному кабинету необходимо войти в систему');
        window.location.href = 'login.html';
        return;
    }
    
    // Заполняем информацию о пользователе
    loadUserInfo();
    updateAuthNav();
});

// Загрузка информации о пользователе
function loadUserInfo() {
    const user = getStoredUser();
    
    if (user) {
        document.getElementById('user-fio').textContent = user.fio || '-';
        document.getElementById('user-email').textContent = user.email || '-';
        document.getElementById('user-phone').textContent = user.phone || 'Не указан';
        document.getElementById('currentEmail').value = user.email || '';
        const role = getUserRole(user);
        document.getElementById('user-role').textContent = getRoleTitle(role);
        const companyRow = document.getElementById('company-row');
        const companyValue = document.getElementById('user-company');
        if (companyRow && companyValue) {
            if (role === 'supplier') {
                companyRow.style.display = 'flex';
                companyValue.textContent = user.company_name || DEFAULT_COMPANY_NAME;
            } else {
                companyRow.style.display = 'none';
                companyValue.textContent = '-';
            }
        }
    }
}

// Обработка изменения email
document.getElementById('changeEmailForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const user = getStoredUser();
    if (!user || !user.id) {
        alert('Ошибка: пользователь не найден');
        return;
    }
    
    const newEmail = document.getElementById('newEmail').value.trim();
    const password = document.getElementById('emailPassword').value;
    const errorMessage = document.getElementById('email-error-message');
    const successMessage = document.getElementById('email-success-message');
    
    // Скрываем предыдущие сообщения
    errorMessage.style.display = 'none';
    successMessage.style.display = 'none';
    
    // Валидация
    if (!newEmail) {
        errorMessage.textContent = 'Введите новый email';
        errorMessage.style.display = 'block';
        return;
    }
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(newEmail)) {
        errorMessage.textContent = 'Неверный формат email';
        errorMessage.style.display = 'block';
        return;
    }
    
    if (newEmail === user.email) {
        errorMessage.textContent = 'Новый email совпадает с текущим';
        errorMessage.style.display = 'block';
        return;
    }
    
    if (!password) {
        errorMessage.textContent = 'Введите пароль для подтверждения';
        errorMessage.style.display = 'block';
        return;
    }
    
    try {
        const response = await fetch(`http://localhost:3000/auth/profile/email`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                userId: user.id,
                newEmail: newEmail,
                password: password
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            // Обновляем данные пользователя в localStorage
            user.email = newEmail;
            localStorage.setItem('user', JSON.stringify(user));
            
            // Обновляем отображение
            loadUserInfo();
            document.getElementById('newEmail').value = '';
            document.getElementById('emailPassword').value = '';
            
            successMessage.textContent = data.message || 'Email успешно изменен!';
            successMessage.style.display = 'block';
            
            // Обновляем меню навигации
            updateAuthNav();
        } else {
            errorMessage.textContent = data.error || 'Ошибка при изменении email';
            errorMessage.style.display = 'block';
        }
    } catch (error) {
        errorMessage.textContent = 'Ошибка подключения к серверу. Проверьте, запущен ли сервер.';
        errorMessage.style.display = 'block';
        console.error('Ошибка:', error);
    }
});

// Обработка изменения пароля
document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const user = getStoredUser();
    if (!user || !user.id) {
        alert('Ошибка: пользователь не найден');
        return;
    }
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmNewPassword = document.getElementById('confirmNewPassword').value;
    const errorMessage = document.getElementById('password-error-message');
    const successMessage = document.getElementById('password-success-message');
    
    // Скрываем предыдущие сообщения
    errorMessage.style.display = 'none';
    successMessage.style.display = 'none';
    
    // Валидация
    if (!currentPassword) {
        errorMessage.textContent = 'Введите текущий пароль';
        errorMessage.style.display = 'block';
        return;
    }
    
    if (newPassword.length < 6) {
        errorMessage.textContent = 'Пароль должен содержать минимум 6 символов';
        errorMessage.style.display = 'block';
        return;
    }
    
    if (newPassword !== confirmNewPassword) {
        errorMessage.textContent = 'Пароли не совпадают';
        errorMessage.style.display = 'block';
        return;
    }
    
    if (currentPassword === newPassword) {
        errorMessage.textContent = 'Новый пароль должен отличаться от текущего';
        errorMessage.style.display = 'block';
        return;
    }
    
    try {
        const response = await fetch(`http://localhost:3000/auth/profile/password`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                userId: user.id,
                currentPassword: currentPassword,
                newPassword: newPassword
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            // Очищаем поля формы
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
            
            successMessage.textContent = data.message || 'Пароль успешно изменен!';
            successMessage.style.display = 'block';
        } else {
            errorMessage.textContent = data.error || 'Ошибка при изменении пароля';
            errorMessage.style.display = 'block';
        }
    } catch (error) {
        errorMessage.textContent = 'Ошибка подключения к серверу. Проверьте, запущен ли сервер.';
        errorMessage.style.display = 'block';
        console.error('Ошибка:', error);
    }
});

// Функция для проверки авторизации и обновления меню пользователя
function updateAuthNav() {
    const isAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
    const user = getStoredUser();
    const userMenuContent = document.getElementById('user-menu-content');
    
    if (userMenuContent) {
        if (isAuthenticated && user) {
            const role = getUserRole(user);
            const companyBlock = role === 'supplier'
                ? `<div class="user-company">${user.company_name || DEFAULT_COMPANY_NAME}</div>`
                : '';
            const adminLink = role === 'admin'
                ? `<a href="admin.html" class="dropdown-item">Админ-панель</a>`
                : '';
            const supplierLink = role === 'supplier'
                ? `<a href="supplier.html" class="dropdown-item">Мои товары</a>`
                : '';

            userMenuContent.innerHTML = `
                <div class="user-info">
                    <div class="user-name">${user.fio}</div>
                    <div class="user-email">${user.email}</div>
                    ${companyBlock}
                </div>
                <div class="dropdown-divider"></div>
                <a href="profile.html" class="dropdown-item">Личный кабинет</a>
                ${adminLink}
                ${supplierLink}
                <a href="#" class="dropdown-item" onclick="logout(); return false;">Выйти</a>
            `;
        } else {
            userMenuContent.innerHTML = `
                <a href="login.html" class="dropdown-item">Войти</a>
                <a href="register.html" class="dropdown-item">Регистрация</a>
            `;
        }
    }
}

// Функция выхода
function logout() {
    localStorage.removeItem('user');
    localStorage.removeItem('isAuthenticated');
    updateAuthNav();
    window.location.href = 'index.html';
}

// Функция для открытия/закрытия меню пользователя
function toggleUserMenu() {
    const dropdown = document.getElementById('user-dropdown');
    if (dropdown) {
        dropdown.classList.toggle('show');
    }
}

// Закрываем меню при клике вне его
document.addEventListener('click', function(event) {
    const userMenuContainer = document.querySelector('.user-menu-container');
    const dropdown = document.getElementById('user-dropdown');
    
    if (userMenuContainer && !userMenuContainer.contains(event.target)) {
        if (dropdown) {
            dropdown.classList.remove('show');
        }
    }
});

// Функция перехода в корзину
function goToCart(event) {
    event.preventDefault();
    window.location.href = 'cart.html';
}

// Функция перехода к заявкам
function goToRequests(event) {
    event.preventDefault();
    const isAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
    const user = getStoredUser();
    
    if (!isAuthenticated || !user) {
        window.location.href = 'login.html';
        return;
    }
    
    const role = (user.role || user.role_name || '').toLowerCase();
    if (role === 'supplier') {
        window.location.href = 'supplier-requests.html';
    } else {
        window.location.href = 'requests.html';
    }
}

// Функция для показа toast-уведомлений
function showCartToast(message) {
    let toastContainer = document.querySelector('.cart-toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'cart-toast-container';
        document.body.appendChild(toastContainer);
    }

    const toast = document.createElement('div');
    toast.className = 'cart-toast';
    toast.textContent = message;
    toastContainer.appendChild(toast);

    requestAnimationFrame(() => {
        toast.classList.add('show');
    });

    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 2500);
}
</script>

</body>
</html>

